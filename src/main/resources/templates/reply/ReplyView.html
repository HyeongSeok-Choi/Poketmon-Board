<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8"> <!-- 수정: meta 태그를 head 태그 안으로 이동 -->
    <title>댓글 시스템</title>
</head>
<body>
<th:block layout:fragment="replyView">
    <!-- 댓글 작성 -->
    <div class="cm_write">
        <fieldset>
            <legend class="skipinfo">댓글 입력</legend>
            <div class="cm_input">
                <p><textarea id="contents" name="contents" onkeyup="countingLength(this);" cols="90" rows="4"
                             placeholder="댓글을 입력해 주세요."></textarea></p>
                <span><button type="button" class="btns" onclick="saveComment();">등 록</button></span>
                <span><button type="button" class="btns" onclick="updateComment();">수정</button></span>
                <span><button type="button" class="btns" onclick="deleteComment();">삭제</button></span>
            </div>
        </fieldset>
    </div>

    <!-- 댓글 렌더링 영역 -->
    <div class="cm_list"></div>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        /*<![CDATA[*/

        window.onload = () => {
            findAllReply(); <!-- 수정: findAllComment()에서 findAllReply()로 변경 -->
        }

        // 전체 댓글 조회
        function findAllReply() {
            const postId = /*[[${result.id}]]*/ 1;  // 테스트용 ID <!-- 수정: 템플릿 표현식 주석으로 변경 -->

            $.ajax({
                url: `/posts/${postId}/comments`,
                type: 'get',
                dataType: 'json',
                async: false,
                success: function (result) {
                    // 1. 조회된 데이터가 없는 경우
                    if (!result.length) {
                        document.querySelector('.cm_list').innerHTML = '<div class="cm_none"><p>등록된 댓글이 없습니다.</p></div>';
                        return false;
                    }

                    // 2. 렌더링 할 HTML을 저장할 변수
                    let commentHtml = '';

                    // 3. 댓글 HTML 추가
                    result.forEach(row => {
                        commentHtml += `
                                <div>

                                    <p class="writer">
                                        <em>${row.crtId}</em>
                                        <span class="date">${dayjs(row.createdDate).format('YYYY-MM-DD HH:mm')}</span>
                                    </p>
                                    <div class="cont"><div class="txt_con">${row.contents}</div></div>
                                    <p class="func_btns">
                                        <button type="button" onclick="openCommentUpdatePopup(${row.id});" class="btns"><span class="icons icon_modify">수정</span></button>
                                        <button type="button" onclick="deleteComment(${row.id});" class="btns"><span class="icons icon_del">삭제</span></button> <!-- 수정: deleteComment 함수 호출 추가 -->
                                    </p>
                                </div>
                            `;
                    });

                    // 4. class가 "cm_list"인 요소를 찾아 HTML을 렌더링
                    document.querySelector('.cm_list').innerHTML = commentHtml;
                },
                error: function (request, status, error) {
                    console.log(error)
                }
            })
        }

        // 댓글 저장
        function saveComment() {
            const contents = document.getElementById('contents');
            isValid(contents, '댓글');

            const postId = /*[[${result.id}]]*/ 1;  // 테스트용 ID <!-- 수정: 템플릿 표현식 주석으로 변경 -->
            const params = {
                postId: postId,
                contents: contents.value,
                writer: '홍길동'
            }

            $.ajax({
                url: `/posts/${postId}/comments`,
                type: 'post',
                dataType: 'text',
                data: params,
                async: false,
                success: function (result) {
                    alert('저장되었습니다.');
                    contents.value = '';
                    document.getElementById('counter').innerText = '0/300자';
                    findAllReply(); <!-- 수정: findAllComment()에서 findAllReply()로 변경 -->
                },
                error: function (request, status, error) {
                    console.log(error)
                }
            })
        }

        // 댓글 수정
        function updateComment(id) {
            const writer = document.getElementById('modalWriter');
            const contents = document.getElementById('modalContent');
            isValid(writer, '작성자');
            isValid(contents, '수정할 내용');

            const postId = /*[[${result.id}]]*/ 1;  // 테스트용 ID <!-- 수정: 템플릿 표현식 주석으로 변경 -->
            const params = {
                id: id,
                postId: postId,
                contents: contents.value,
                crtId: writer.value
            }

            $.ajax({
                url: `/posts/${postId}/comments/${id}`,
                type: 'patch',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify(params),
                async: false,
                success: function (result) {
                    alert('수정되었습니다.');
                    closeCommentUpdatePopup();
                    findAllReply(); <!-- 수정: findAllComment()에서 findAllReply()로 변경 -->
                },
                error: function (request, status, error) {
                    console.log(error)
                }
            })
        }

        /*]]>*/
    </script>
</th:block>
</body>
</html>
