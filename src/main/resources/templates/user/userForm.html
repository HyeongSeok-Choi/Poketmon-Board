<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/defaultLayout}"
      layout:fragment="Content">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <style>
        .input-form {
            max-width: 100%;
            padding: 32px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
        }

        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-container input[type="text"],
        .input-container input[type="email"],
        .input-container input[type="password"] {
            width: 100%;
            margin-bottom: 15px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
        }

        .btn-container button {
            margin: 0 10px;
        }

        .fieldError {
            color: #bd2130;
            text-align: center;
        }

        .check-button-container {
            text-align: center;
        }

        #checkUserIdBtn {
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="input-form-backgroud row justify-content-center">
        <div class="input-form col-md-6">
            <form id="signupForm" action="/user/new" role="form" method="post" th:object="${userFormDto}">
                <h4 class="mb-3 text-center">회원 가입</h4>

                <div class="input-container">
                    <div class="row">
                        <div class="col-md-12 mb-10">
                            <label for="userId">아이디</label>
                            <input type="text" class="form-control" id="userId" name="userId" th:field="*{userId}" placeholder="아이디를 입력해주세요">
                            <button type="button" id="checkUserIdBtn" class="btn btn-secondary mt-2">중복 확인</button>
                            <p id="userIdError" class="fieldError"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-10">
                            <label for="password">비밀번호</label>
                            <input type="password" class="form-control" id="password" name="password" th:field="*{password}" placeholder="비밀번호 입력">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-10">
                            <label for="checkPassword">비밀번호 확인</label>
                            <input type="password" class="form-control" id="checkPassword" name="checkPassword" th:field="*{checkPassword}" placeholder="비밀번호 확인">
                            <p th:if="${#fields.hasErrors('checkPassword')}" th:errors="*{checkPassword}" class="fieldError">일치하지 않습니다.</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-10">
                            <label for="email">이메일</label>
                            <input type="email" class="form-control" id="email" name="email" th:field="*{email}" placeholder="이메일을 입력해주세요">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-10">
                            <label for="nickName">닉네임</label>
                            <input type="text" class="form-control" id="nickName" name="nickName" th:field="*{nickName}" placeholder="닉네임을 입력해주세요">
                        </div>
                    </div>
                </div>
                <hr/>
                <div class="btn-container">
                    <button id="signupBtn" class="btn btn-primary btn-lg" type="submit" disabled>가입하기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkUserIdBtn = document.getElementById('checkUserIdBtn');
        const userIdInput = document.getElementById('userId');
        const signupBtn = document.getElementById('signupBtn');
        const userIdError = document.getElementById('userIdError');
        const passwordInput = document.getElementById('password');
        const checkPasswordInput = document.getElementById('checkPassword');
        const emailInput = document.getElementById('email');
        const nickNameInput = document.getElementById('nickName');
        let isUserIdValid = false;

        checkUserIdBtn.addEventListener('click', function() {
            const userId = userIdInput.value.trim();
            if (userId) {
                fetch(`/user/checkUserId?userId=${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.isDuplicate) {
                            userIdError.textContent = '아이디가 중복되었습니다. 다른 아이디를 입력해주세요.';
                            isUserIdValid = false;
                        } else {
                            userIdError.textContent = '사용 가능한 아이디입니다.';
                            isUserIdValid = true;
                        }
                        toggleSignupButton();
                    })
                    .catch(() => {
                        userIdError.textContent = '아이디 중복 확인 중 오류가 발생했습니다.';
                        isUserIdValid = false;
                        toggleSignupButton();
                    });
            } else {
                userIdError.textContent = '아이디를 입력해주세요.';
                isUserIdValid = false;
                toggleSignupButton();
            }
        });

        function toggleSignupButton() {
            signupBtn.disabled = !isUserIdValid;
        }

        document.getElementById('signupForm').addEventListener('submit', function(event) {
            const fields = [
                { input: userIdInput, message: '아이디를 입력해주세요.' },
                { input: passwordInput, message: '비밀번호를 입력해주세요.' },
                { input: checkPasswordInput, message: '비밀번호 확인을 입력해주세요.' },
                { input: emailInput, message: '이메일을 입력해주세요.' },
                { input: nickNameInput, message: '닉네임을 입력해주세요.' }
            ];
            let allFieldsFilled = true;

            for (const field of fields) {
                if (!field.input.value.trim()) {
                    alert(field.message);
                    field.input.focus();
                    allFieldsFilled = false;
                    break;
                }
            }

            if (!allFieldsFilled) {
                event.preventDefault();
            }
        });
    });
</script>
</body>
</html>
